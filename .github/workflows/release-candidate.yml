name: Create Release Bundle and Promote

on:
  push:
    tags:
      - '*-rc-[0-9]*' # Regex pattern to match tags suffixed with '-rc-' followed by a number
jobs:
  promote-and-create-release-candidate:
    runs-on: ubuntu-latest
    env:
      JF_ENV_1: ${{ secrets.JF_ENV_1 }}
      JFROG_BUILD_STATUS: PASS
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v3
        with:
          version: latest
      - name: Set up JDK 17
        uses: actions/setup-java@v2
        with:
          java-version: '17'
          distribution: 'temurin'
      - name: test curl
        run: |
          which curl
          curl --version
      - name: test jf
        run: |
          which jf
          jf --version
      - name: Store Commit ID of Tagged Code
        id: tag_commit_sha
        run: |
          echo "COMMIT_SHA=$(git rev-list -n 1 ${{ github.ref }})" >> $GITHUB_OUTPUT
      - name: Print Full Ref (tag)
        run: |
          echo "Tag: ${{ github.ref }}"
      - name: Print Ref (tag) Name
        run: |
          echo "Tag: ${{ github.ref_name }}"
      - name: Print Commit ID
        run: |
          echo "Commit ID: ${{ steps.tag_commit_sha.outputs.COMMIT_SHA }}"
      - name: Execute Build Query
        id: build_query_result
        env:
          COMMIT_SHA: ${{ steps.tag_commit_sha.outputs.COMMIT_SHA }}
          JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
          BUILD_NAME: ${{ github.repository }}
        run: |
          {
          echo 'QUERY_RESULT<<EOF'
          curl --request POST \
          --url https://tomjfrog.jfrog.io/artifactory/api/search/aql \
          --header "Authorization: Bearer $JF_ACCESS_TOKEN" \
          --header 'Content-Type: text/plain' \
          --data "builds.find({
              \"name\": \"$BUILD_NAME\"
           })        
          .include(\"name\", \"number\", \"created\")
          .sort({\"\$desc\": [\"created\"]})
          .limit(1)"
          echo EOF
          } >> $GITHUB_OUTPUT
      - name: Store Build Name and Number
        id: store_build_name_and_number
        env:
          QUERY_RESULT: ${{ steps.build_query_result.outputs.QUERY_RESULT }}
        run: |
          echo "BUILD_NAME=$(echo $QUERY_RESULT | jq -r '.results[0]."build.name"')" >> $GITHUB_OUTPUT
          echo "BUILD_NUMBER=$(echo $QUERY_RESULT | jq -r '.results[0]."build.number"')" >> $GITHUB_OUTPUT
          echo "Build Name: $BUILD_NAME"
          echo "Build Number: $BUILD_NUMBER"
      - name: Create Build Spec for Release Bundle
        id: release_bundle_build_spec
        env:
          BUILD_NAME: ${{ steps.store_build_name_and_number.outputs.BUILD_NAME }}
          BUILD_NUMBER: ${{ steps.store_build_name_and_number.outputs.BUILD_NUMBER }}
        run: |
          {
            echo 'SPEC<<EOF'
            echo "{
                    \"builds\": [
                      {
                        \"name\": \"$BUILD_NAME\",
                        \"number\": \"$BUILD_NUMBER\"
                      }
                    ]
                  }"
             echo EOF
          } >> $GITHUB_OUTPUT
      - name: Write to File
        id: create-temp-file
        env:
          SPEC: ${{ steps.release_bundle_build_spec.outputs.SPEC }}
        run: |
          # Create a temporary file
          TEMP_FILE=$(mktemp)
          
          # Write content to the temporary file
          echo $SPEC > $TEMP_FILE
          
          # Display the path of the temporary file
          echo "Temporary file path: $TEMP_FILE"
          
          # Set the path as an output for other steps to use
          echo "::set-output name=temp-file-path::$TEMP_FILE"
      - name: Create Release Bundle
        id: create_release_bundle
        env:
            TEMP_FILE_PATH: ${{ steps.create-temp-file.outputs.temp-file-path }}
        run: |
            jf release-bundle-create --builds $TEMP_FILE_PATH --signing-key ${{ secrets.RELEASE_BUNDLE_SIGNING_KEY }} ${{ github.repository }}-release-bundle ${{ github.ref_name }}
