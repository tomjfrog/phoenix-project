name: Create Release Bundle and Promote

on:
  push:
    tags:
      - '*-rc-[0-9]*' # Regex pattern to match tags suffixed with '-rc-' followed by a number
jobs:
  promote-and-create-release-candidate:
    runs-on: ubuntu-latest
    env:
      JF_ENV_1: ${{ secrets.JF_ENV_1 }}
      JFROG_BUILD_STATUS: PASS
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v3
      - name: Set up JDK 17
        uses: actions/setup-java@v2
        with:
          java-version: '17'
          distribution: 'temurin'
      - name: Store Commit ID of Tagged Code
        id: tag_commit_sha
        run: |
          echo "COMMIT_SHA=$(git rev-list -n 1 ${{ github.ref }})" >> $GITHUB_OUTPUT
      - name: Print Full Ref (tag)
        run: |
          echo "Tag: ${{ github.ref }}"
      - name: Print Ref (tag) Name
        run: |
          echo "Tag: ${{ github.ref_name }}"
      - name: Print Commit ID
        run: |
          echo "Commit ID: ${{ steps.tag_commit_sha.outputs.COMMIT_SHA }}"
      - name: Create Build Query Spec
        id: create_build_query_spec
        run: |
          echo SPEC="builds.find({
                 "@buildInfo.env.GITHUB_SHA": ${{ steps.commit_sha.outputs.COMMIT_SHA }}
                }).include("name", "number")">> $GITHUB_ENV
      - name: Execute Build Query
        id: build_query_result
        run: |
          {
            echo 'QUERY_RESULT<<EOF'
            jf s --spec ${{ steps.create_build_query_spec.outputs.SPEC }}
            echo EOF
          } >> $GITHUB_ENV
      - name: Store Build Name and Number
        id: store_build_name_and_number
        env:
          QUERY_RESULT: ${{ steps.build_query_result.outputs.QUERY_RESULT }}
        run: |
          echo "BUILD_NAME=$(echo "QUERY_RESULT" | jq -r '.results[0]."build.name"')" >> $GITHUB_ENV
          echo "BUILD_NUMBER=$(echo "QUERY_RESULT" | jq -r '.results[0]."build.number"')" >> $GITHUB_ENV
          echo "Build Name: $BUILD_NAME"
          echo "Build Number: $BUILD_NUMBER"
      - name: Create Build Spec for Release Bundle
        id: release_bundle_build_spec
        env:
          BUILD_NAME: ${{ steps.store_build_name_and_number.outputs.BUILD_NAME }}
          BUILD_NUMBER: ${{ steps.store_build_name_and_number.outputs.BUILD_NUMBER }}
        run: |
          echo SPEC='{
                 "builds": [
                   {
                     "name": "$BUILD_NAME",
                     "number": "$BUILD_NUMBER"
                   }
                 ]
               }'>> $GITHUB_ENV
      - name: Create Release Bundle
        id: create_release_bundle
        env:
            SPEC: ${{ steps.release_bundle_build_spec.outputs.SPEC }}
        run: |
          {
            echo 'RELEASE_BUNDLE<<EOF'
            jf release-bundle-create --builds $SPEC --signing-key ${{ secrets.RELEASE_BUNDLE_SIGNING_KEY }} Phoenix-Release-Bundle-${{ github.ref_name }} ${{ github.run_number }}
            echo EOF
          } >> $GITHUB_ENV
